# ** COMP **
alias pxc='proxychains'
alias pxc4='proxychains4'

# Proxy
http_proxy='http://alan1:xe&UvMTrrEOiPhA7@10.5.33.2:6777'
https_proxy='http://alan1:xe&UvMTrrEOiPhA7@10.5.33.2:6777'
no_proxy=localhost,::1,127.0.0.1

HTTP_PROXY='http://alan1:xe&UvMTrrEOiPhA7@10.5.33.2:6777'
HTTPS_PROXY='http://alan1:xe&UvMTrrEOiPhA7@10.5.33.2:6777'
NO_PROXY=localhost,::1,127.0.0.1

# Tunnel Configs
TUNNEL_HOST="spark-master"
TUNNEL_PORT="8011"
TUNNEL_PID_FILE="$HOME/.ssh-tunnel.pid"
TUNNEL_LOG_FILE="$HOME/.ssh-tunnel.log"

enable_terminal_proxy() {
    export http_proxy
    export https_proxy
    export no_proxy
    export HTTP_PROXY
    export HTTPS_PROXY
    export NO_PROXY
}

disable_terminal_proxy() {
    unset http_proxy
    unset https_proxy
    unset no_proxy
    unset HTTP_PROXY
    unset HTTPS_PROXY
    unset NO_PROXY
}

restart_docker() {
    sudo systemctl daemon-reload
    sudo systemctl restart docker
}

enable_docker_proxy() {
    sudo touch "$/etc/systemd/system/docker.service.d/http-proxy.conf"
    {
        echo '[Service]'
        echo "Environment=\"HTTP_PROXY=$HTTP_PROXY\""
        echo "Environment=\"HTTPS_PROXY=$HTTPS_PROXY\""
        echo "Environment=\"NO_PROXY=$NO_PROXY\""
    } | sudo tee "$/etc/systemd/system/docker.service.d/http-proxy.conf" > /dev/null
    restart_docker
}

disable_docker_proxy() {
    echo '' | sudo tee "$/etc/systemd/system/docker.service.d/http-proxy.conf" > /dev/null
    restart_docker
}

is_ssh_tunnel_running() {
    [[ -f "$TUNNEL_PID_FILE" ]] && kill -0 "$(cat "$TUNNEL_PID_FILE")" 2>/dev/null
}

start_ssh_tunnel() {
    if is_ssh_tunnel_running; then
        echo "SSH Tunnel already running (PID: $(cat "$TUNNEL_PID_FILE"))"
        return 0
    fi

    echo "Starting SSH tunnel to $TUNNEL_HOST on port $TUNNEL_PORT..."
    ssh -D "$TUNNEL_PORT" -N -f \
        -o ServerAliveInterval=60 \
        -o ServerAliveCountMax=3 \
        -o ExitOnForwardFailure=yes \
        "$TUNNEL_HOST" \
        2>> "$TUNNEL_LOG_FILE"

    # Save PID
    pgrep -f "ssh -D $TUNNEL_PORT -N" > "$TUNNEL_PID_FILE"

    if is_ssh_tunnel_running; then
        echo "SSH Tunnel started successfully (PID: $(cat "$TUNNEL_PID_FILE"))"
    else
        echo "Failed to start tunnel. Check $TUNNEL_LOG_FILE"
        return 1
    fi
}

stop_ssh_tunnel() {
    if ! is_ssh_tunnel_running; then
        echo "SSH Tunnel is not running"
        return 1
    fi

    local pid=$(cat "$TUNNEL_PID_FILE")
    echo "Stopping SSH tunnel (PID: $pid)..."
    kill "$pid" 2>/dev/null
    rm -f "$TUNNEL_PID_FILE"
    echo "SSH Tunnel stopped"
}

restart_ssh_tunnel() {
    stop_ssh_tunnel
    sleep 1
    start_ssh_tunnel
}

status_ssh_tunnel() {
    if is_ssh_tunnel_running; then
        local pid=$(cat "$TUNNEL_PID_FILE")
        echo "SSH Tunnel is running (PID: $pid)"
        echo "SOCKS5 proxy: socks5://127.0.0.1:$TUNNEL_PORT"
        
        # Test if it's actually working
        if command -v curl &> /dev/null; then
            echo -n "Testing connection... "
            if curl -s --proxy "socks5://127.0.0.1:$TUNNEL_PORT" \
                --max-time 5 https://chat.openai.com > /dev/null 2>&1; then
                echo "Working"
            else
                echo "Not responding"
            fi
        fi
    else
        echo "SSH Tunnel is not running"
        # Check if port is occupied by something else
        local existing_pid=$(lsof -ti:$TUNNEL_PORT 2>/dev/null)
        if [[ -n "$existing_pid" ]]; then
            echo "Port $TUNNEL_PORT is occupied by PID: $existing_pid"
            echo "Run 'stop_tunnel' to clean up"
        fi
        return 1
    fi
}

ssh_tunnel_on() {
    if ! is_ssh_tunnel_running; then
        echo "SSH Tunnel is not running, starting..."
        start_ssh_tunnel || return 1
    fi
    export https_proxy=socks5://127.0.0.1:$TUNNEL_PORT
    export http_proxy=socks5://127.0.0.1:$TUNNEL_PORT
    export all_proxy=socks5://127.0.0.1:$TUNNEL_PORT
    export HTTPS_PROXY=socks5://127.0.0.1:$TUNNEL_PORT
    export HTTP_PROXY=socks5://127.0.0.1:$TUNNEL_PORT
    export ALL_PROXY=socks5://127.0.0.1:$TUNNEL_PORT
    echo "Proxy enabled via SSH tunnel"
}

ssh_tunnel_off() {
    unset https_proxy
    unset http_proxy
    unset all_proxy
    unset HTTPS_PROXY
    unset HTTP_PROXY
    unset ALL_PROXY
    echo "Proxy disabled"
}

alias epx='enable_terminal_proxy'
alias dpx='disable_terminal_proxy'
alias rsdk='restart_docker'
alias edkpx='enable_docker_proxy'
alias ddkpx='disable_docker_proxy'
alias tstart='start_ssh_tunnel'
alias tstop='stop_ssh_tunnel'
alias tstatus='status_ssh_tunnel'
alias ton='ssh_tunnel_on'
alias toff='ssh_tunnel_off'
